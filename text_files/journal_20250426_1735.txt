OK the refactored code seems to work?